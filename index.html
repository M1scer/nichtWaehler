<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NichtWähler</title>
<style>
  /* Reset & Grundlayout */
  * {
    box-sizing: border-box;
  }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f5f8fa;
    color: #222;
    margin: 1.5rem 2rem;
  }
  h1 {
    color: #2c3e50;
    margin-bottom: 1rem;
  }
  input[type="search"] {
    width: 100%;
    max-width: 420px;
    padding: 0.5rem 0.75rem;
    font-size: 1.1rem;
    border: 2px solid #3498db;
    border-radius: 8px;
    margin-bottom: 1.5rem;
    transition: border-color 0.25s ease;
  }
  input[type="search"]:focus {
    outline: none;
    border-color: #2980b9;
    box-shadow: 0 0 5px #2980b9;
  }

  /* Tabelle modern */
  table {
    width: 100%;
    border-collapse: collapse;
    box-shadow: 0 6px 18px rgb(0 0 0 / 0.1);
    border-radius: 12px;
    overflow: hidden;
    background: white;
  }
  thead {
    background: linear-gradient(90deg, #2980b9, #3498db);
    color: white;
    user-select: none;
  }
  th, td {
    padding: 12px 20px;
    text-align: left;
    vertical-align: middle;
  }
  tbody tr {
    border-bottom: 1px solid #ecf0f1;
    transition: background-color 0.25s ease;
  }
  tbody tr:hover {
    background-color: #f0f8ff;
  }
  th {
    cursor: pointer;
    position: relative;
  }
  th.sort-asc::after {
    content: "▲";
    position: absolute;
    right: 15px;
    font-size: 0.8rem;
  }
  th.sort-desc::after {
    content: "▼";
    position: absolute;
    right: 15px;
    font-size: 0.8rem;
  }
  /* Responsive */
  @media (max-width: 900px) {
    table, thead, tbody, th, td, tr {
      display: block;
    }
    thead tr {
      display: none;
    }
    tbody tr {
      margin-bottom: 1rem;
      background: white;
      border-radius: 12px;
      box-shadow: 0 3px 12px rgb(0 0 0 / 0.05);
      padding: 1rem;
    }
    tbody td {
      padding: 8px 12px;
      text-align: right;
      position: relative;
      border-bottom: 1px solid #eee;
    }
    tbody td:last-child {
      border-bottom: none;
    }
    tbody td::before {
      content: attr(data-label);
      position: absolute;
      left: 12px;
      width: 50%;
      padding-left: 10px;
      font-weight: 700;
      text-align: left;
      color: #2980b9;
    }
  }

  /* ✓ / ✗ Styling */
  .bool-true {
    color: #27ae60;
    font-weight: bold;
    font-size: 1.3rem;
    text-align: center;
  }
  .bool-false {
    color: #c0392b;
    font-weight: bold;
    font-size: 1.3rem;
    text-align: center;
  }
  /* Links */
  a {
    color: #2980b9;
    text-decoration: none;
  }
  a:hover {
    text-decoration: underline;
  }
  /* Fehlermeldung */
  #resultsTableBody td[colspan="7"] {
    text-align: center;
    font-style: italic;
    color: #555;
  }
</style>
</head>
<body>
  <h1>NichtWähler</h1>
  <input id="searchInput" type="search" placeholder="Suche nach Partei, Titel, Kategorie..." aria-label="Suche" />

  <table aria-label="Datenübersicht">
    <thead>
      <tr>
        <th data-key="Datum" scope="col" tabindex="0">Datum</th>
        <th data-key="Regierungsbeteiligung" scope="col" tabindex="0">Regierung</th>
        <th data-key="Partei" scope="col" tabindex="0">Partei</th>
        <th data-key="Titel" scope="col" tabindex="0">Titel</th>
        <th data-key="Beschreibung" scope="col" tabindex="0">Beschreibung</th>
        <th data-key="Kategorie" scope="col" tabindex="0">Kategorie</th>
        <th data-key="Quellen" scope="col" tabindex="0">Quellen</th>
      </tr>
    </thead>
    <tbody id="resultsTableBody">
      <tr><td colspan="7">Daten werden geladen...</td></tr>
    </tbody>
  </table>

<script>
(async () => {
  const filesListUrl = './files.json'; // liegt im gleichen Ordner wie index.html
  const dataFolderPath = './data/';  // Daten liegen ein Ordner höher im data/
  const resultsBody = document.getElementById('resultsTableBody');
  const searchInput = document.getElementById('searchInput');

  let allEntries = [];
  let currentSortKey = null;
  let currentSortDir = 1; // 1=aufsteigend, -1=absteigend

  function parseBoolean(val) {
    if (typeof val === 'boolean') return val;
    if (typeof val === 'string') {
      return ['true', '1', 'ja', '✓'].includes(val.toLowerCase());
    }
    return false;
  }

  function extractDomain(url) {
    try {
      let hostname = new URL(url).hostname;
      if (hostname.startsWith('www.')) hostname = hostname.slice(4);
      return hostname;
    } catch {
      return url;
    }
  }

  async function loadData() {
    resultsBody.innerHTML = `<tr><td colspan="7">Lade Dateiliste...</td></tr>`;
    try {
      const resFiles = await fetch(filesListUrl);
      if (!resFiles.ok) throw new Error('files.json nicht gefunden');
      const files = await resFiles.json();

      const dataArrays = await Promise.all(files.map(async (file) => {
        try {
          const res = await fetch(dataFolderPath + file);
          if (!res.ok) throw new Error(`Datei ${file} nicht gefunden`);
          const data = await res.json();
          if (!Array.isArray(data)) return [];
          return data;
        } catch (e) {
          console.warn(e);
          return [];
        }
      }));

      allEntries = dataArrays.flat();
      renderTable();
    } catch (e) {
      resultsBody.innerHTML = `<tr><td colspan="7" style="color: red;">Fehler: ${e.message}</td></tr>`;
    }
  }

  function renderTable() {
    const filter = searchInput.value.trim().toLowerCase();

    let filtered = allEntries.filter(entry => 
      Object.values(entry).some(val => val && val.toString().toLowerCase().includes(filter))
    );

    if (currentSortKey) {
      filtered.sort((a, b) => {
        let aVal = a[currentSortKey] ?? '';
        let bVal = b[currentSortKey] ?? '';

        if (currentSortKey === 'Regierungsbeteiligung') {
          aVal = parseBoolean(aVal) ? 1 : 0;
          bVal = parseBoolean(bVal) ? 1 : 0;
        } else {
          aVal = aVal.toString().toLowerCase();
          bVal = bVal.toString().toLowerCase();
        }
        if (aVal < bVal) return -1 * currentSortDir;
        if (aVal > bVal) return 1 * currentSortDir;
        return 0;
      });
    }

    if (filtered.length === 0) {
      resultsBody.innerHTML = `<tr><td colspan="7">Keine Ergebnisse gefunden</td></tr>`;
      return;
    }

    resultsBody.innerHTML = '';
    for (const entry of filtered) {
      const regBool = parseBoolean(entry.Regierungsbeteiligung);

      // Alle Quellen extrahieren (keys wie Quelle1, Quelle2,...)
      const quellenLinks = Object.entries(entry)
        .filter(([key]) => key.toLowerCase().startsWith('quelle') && entry[key])
        .map(([_, url]) => {
          const domain = extractDomain(url);
          return `<a href="${url}" target="_blank" rel="noopener noreferrer">${domain}</a>`;
        })
        .join(', ');

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td data-label="Datum">${entry.Datum || ''}</td>
        <td data-label="Regierung" class="${regBool ? 'bool-true' : 'bool-false'}" style="text-align:center;">
          ${regBool ? '✓' : '✗'}
        </td>
        <td data-label="Partei">${entry.Partei || ''}</td>
        <td data-label="Titel">${entry.Titel || ''}</td>
        <td data-label="Beschreibung">${entry.Beschreibung || ''}</td>
        <td data-label="Kategorie">${entry.Kategorie || ''}</td>
        <td data-label="Quellen">${quellenLinks}</td>
      `;
      resultsBody.appendChild(tr);
    }
  }

  // Sortierung bei Klick auf Spaltenüberschrift
  document.querySelectorAll('th').forEach(th => {
    th.addEventListener('click', () => {
      const key = th.getAttribute('data-key');
      if (currentSortKey === key) {
        currentSortDir = -currentSortDir; // umkehren
      } else {
        currentSortKey = key;
        currentSortDir = 1;
      }
      // Alle th Klassen zurücksetzen
      document.querySelectorAll('th').forEach(th2 => {
        th2.classList.remove('sort-asc', 'sort-desc');
      });
      th.classList.add(currentSortDir === 1 ? 'sort-asc' : 'sort-desc');
      renderTable();
    });
    // Keyboard Accessibility: sortieren auch per Enter
    th.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        th.click();
      }
    });
  });

  searchInput.addEventListener('input', renderTable);

  await loadData();
})();
</script>

</body>
</html>
