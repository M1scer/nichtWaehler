<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="data:image/svg+xml,
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'>
  <circle cx='8' cy='8' r='7' fill='none' stroke='blue' stroke-width='2'/>
  <line x1='4' y1='4' x2='12' y2='12' stroke='blue' stroke-width='2'/>
  <line x1='12' y1='4' x2='4' y2='12' stroke='blue' stroke-width='2'/>
</svg>">
<style>
  /* Reset & Grundlayout */
  * {
    box-sizing: border-box;
  }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f5f8fa;
    color: #222;
    margin: 1.5rem 2rem;
  }
  h1 {
    color: #2c3e50;
    margin-bottom: 1rem;
  }
  input[type="search"] {
    width: 100%;
    max-width: 420px;
    padding: 0.5rem 0.75rem;
    font-size: 1.1rem;
    border: 2px solid #3498db;
    border-radius: 8px;
    margin-bottom: 1.5rem;
    transition: border-color 0.25s ease;
  }
  input[type="search"]:focus {
    outline: none;
    border-color: #2980b9;
    box-shadow: 0 0 5px #2980b9;
  }

  /* Tabelle modern */
  table {
    width: 100%;
    border-collapse: collapse;
    box-shadow: 0 6px 18px rgb(0 0 0 / 0.1);
    border-radius: 12px;
    overflow: hidden;
    background: white;
  }
  thead {
    background: linear-gradient(90deg, #2980b9, #3498db);
    color: white;
    user-select: none;
  }
  th, td {
    padding: 12px 20px;
    text-align: left;
    vertical-align: middle;
  }
  tbody tr {
    border-bottom: 1px solid #ecf0f1;
    transition: background-color 0.25s ease;
  }
  tbody tr:hover {
    background-color: #f0f8ff;
  }
  th {
    cursor: pointer;
    position: relative;
  }
  th.sort-asc::after {
    content: "▲";
    position: absolute;
    right: 15px;
    font-size: 0.8rem;
  }
  th.sort-desc::after {
    content: "▼";
    position: absolute;
    right: 15px;
    font-size: 0.8rem;
  }
  /* Responsive */
  @media (max-width: 900px) {
    table, thead, tbody, th, td, tr {
      display: block;
    }
    thead tr {
      display: none;
    }
    tbody tr {
      margin-bottom: 1rem;
      background: white;
      border-radius: 12px;
      box-shadow: 0 3px 12px rgb(0 0 0 / 0.05);
      padding: 1rem;
    }
    tbody td {
      padding: 8px 12px;
      text-align: right;
      position: relative;
      border-bottom: 1px solid #eee;
    }
    tbody td:last-child {
      border-bottom: none;
    }
    tbody td::before {
      content: attr(data-label);
      position: absolute;
      left: 12px;
      width: 50%;
      padding-left: 10px;
      font-weight: 700;
      text-align: left;
      color: #2980b9;
    }
  }

  /* ✓ / ✗ Styling */
  .bool-true {
    color: #27ae60;
    font-weight: bold;
    font-size: 1.3rem;
    text-align: center;
  }
  .bool-false {
    color: #c0392b;
    font-weight: bold;
    font-size: 1.3rem;
    text-align: center;
  }
  /* Links */
  a {
    color: #2980b9;
    text-decoration: none;
  }
  a:hover {
    text-decoration: underline;
  }
  /* Fehlermeldung */
  #resultsTableBody td[colspan="7"] {
    text-align: center;
    font-style: italic;
    color: #555;
  }
</style>
</head>
<body>
  <header style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; margin-bottom: 1.5rem; gap: 1rem; max-width: 1000px;">
    <div style="flex: 1; min-width: 280px;">
      <h1 style="margin: 0 0 0.5rem 0;">NichtWähler</h1>
      <input id="searchInput" type="search" placeholder="Suche nach Partei, Titel, Kategorie..." aria-label="Suche"
             style="width: 100%; max-width: 420px; padding: 0.5rem 0.75rem; font-size: 1.1rem; border: 2px solid #3498db; border-radius: 8px; transition: border-color 0.25s ease;">
    </div>
    <div style="flex: 1; min-width: 280px; font-size: 0.95rem; color: #555; max-width: 450px; line-height: 1.4;">
      <p style="margin: 0;">
        Trotz allem: Geh wählen – nur so kannst du Veränderung bewirken!  
        Und wenn du wissen willst, welche guten Entscheidungen schon getroffen wurden, schau bei den 
        <a href="https://m1scer.github.io/dochWaehler/" style="color:#2980b9; text-decoration:none;">„DochWähler“-Highlights</a> vorbei.
      </p>
    </div>
  </header>
  <input id="searchInput" type="search" placeholder="Suche nach Partei, Titel, Kategorie..." aria-label="Suche" />

  <table aria-label="Datenübersicht">
    <thead>
      <tr>
        <th data-key="Datum" scope="col" tabindex="0">Datum</th>
        <th data-key="Regierungsbeteiligung" scope="col" tabindex="0">Regierung</th>
        <th data-key="Partei" scope="col" tabindex="0">Partei</th>
        <th data-key="Titel" scope="col" tabindex="0">Titel</th>
        <th data-key="Beschreibung" scope="col" tabindex="0">Beschreibung</th>
        <th data-key="Kategorie" scope="col" tabindex="0">Kategorie</th>
        <th data-key="Quellen" scope="col" tabindex="0">Quellen</th>
      </tr>
    </thead>
    <tbody id="resultsTableBody">
      <tr><td colspan="7">Daten werden geladen...</td></tr>
    </tbody>
  </table>

<script>
(async () => {
  const filesListUrl = './files.json'; // liegt im gleichen Ordner wie index.html
  const dataFolderPath = './data/';  // Daten liegen ein Ordner höher im data/
  const resultsBody = document.getElementById('resultsTableBody');
  const searchInput = document.getElementById('searchInput');

  let allEntries = [];
  let currentSortKey = null;
  let currentSortDir = 1; // 1=aufsteigend, -1=absteigend

  function parseBoolean(val) {
    if (typeof val === 'boolean') return val;
    if (typeof val === 'string') {
      return ['true', '1', 'ja', '✓'].includes(val.toLowerCase());
    }
    return false;
  }

  function extractDomain(url) {
    try {
      let hostname = new URL(url).hostname;
      if (hostname.startsWith('www.')) hostname = hostname.slice(4);
      return hostname;
    } catch {
      return url;
    }
  }

  async function loadData() {
    resultsBody.innerHTML = `<tr><td colspan="7">Lade Dateiliste...</td></tr>`;
    try {
      const resFiles = await fetch(filesListUrl);
      if (!resFiles.ok) throw new Error('files.json nicht gefunden');
      const files = await resFiles.json();

      const dataArrays = await Promise.all(files.map(async (file) => {
        try {
          const res = await fetch(dataFolderPath + file);
          if (!res.ok) throw new Error(`Datei ${file} nicht gefunden`);
          const data = await res.json();
          if (!Array.isArray(data)) return [];
          return data;
        } catch (e) {
          console.warn(e);
          return [];
        }
      }));

      allEntries = dataArrays.flat();
      renderTable();
    } catch (e) {
      resultsBody.innerHTML = `<tr><td colspan="7" style="color: red;">Fehler: ${e.message}</td></tr>`;
    }
  }

  function renderTable() {
    const filter = searchInput.value.trim().toLowerCase();

    let filtered = allEntries.filter(entry => 
      Object.values(entry).some(val => val && val.toString().toLowerCase().includes(filter))
    );

    if (currentSortKey) {
      filtered.sort((a, b) => {
        let aVal = a[currentSortKey] ?? '';
        let bVal = b[currentSortKey] ?? '';

        if (currentSortKey === 'Regierungsbeteiligung') {
          aVal = parseBoolean(aVal) ? 1 : 0;
          bVal = parseBoolean(bVal) ? 1 : 0;
        } else {
          aVal = aVal.toString().toLowerCase();
          bVal = bVal.toString().toLowerCase();
        }
        if (aVal < bVal) return -1 * currentSortDir;
        if (aVal > bVal) return 1 * currentSortDir;
        return 0;
      });
    }

    if (filtered.length === 0) {
      resultsBody.innerHTML = `<tr><td colspan="7">Keine Ergebnisse gefunden</td></tr>`;
      return;
    }

    resultsBody.innerHTML = '';
    for (const entry of filtered) {
      const regBool = parseBoolean(entry.Regierungsbeteiligung);

      // Alle Quellen extrahieren (keys wie Quelle1, Quelle2,...)
      const quellenLinks = Object.entries(entry)
        .filter(([key]) => key.toLowerCase().startsWith('quelle') && entry[key])
        .map(([_, url]) => {
          const domain = extractDomain(url);
          return `<a href="${url}" target="_blank" rel="noopener noreferrer">${domain}</a>`;
        })
        .join(', ');

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td data-label="Datum">${entry.Datum || ''}</td>
        <td data-label="Regierung" class="${regBool ? 'bool-true' : 'bool-false'}" style="text-align:center;">
          ${regBool ? '✓' : '✗'}
        </td>
        <td data-label="Partei">${entry.Partei || ''}</td>
        <td data-label="Titel">${entry.Titel || ''}</td>
        <td data-label="Beschreibung">${entry.Beschreibung || ''}</td>
        <td data-label="Kategorie">${entry.Kategorie || ''}</td>
        <td data-label="Quellen">${quellenLinks}</td>
      `;
      resultsBody.appendChild(tr);
    }
  }

  // Sortierung bei Klick auf Spaltenüberschrift
  document.querySelectorAll('th').forEach(th => {
    th.addEventListener('click', () => {
      const key = th.getAttribute('data-key');
      if (currentSortKey === key) {
        currentSortDir = -currentSortDir; // umkehren
      } else {
        currentSortKey = key;
        currentSortDir = 1;
      }
      // Alle th Klassen zurücksetzen
      document.querySelectorAll('th').forEach(th2 => {
        th2.classList.remove('sort-asc', 'sort-desc');
      });
      th.classList.add(currentSortDir === 1 ? 'sort-asc' : 'sort-desc');
      renderTable();
    });
    // Keyboard Accessibility: sortieren auch per Enter
    th.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        th.click();
      }
    });
  });

  searchInput.addEventListener('input', renderTable);

  await loadData();
})();
</script>
<a href="https://github.com/M1scer/nichtWaehler" target="_blank" rel="noopener noreferrer" 
   aria-label="GitHub Repository" 
   style="
     position: fixed;
     top: 12px;
     right: 12px;
     width: 32px;
     height: 32px;
     opacity: 0.5;
     transition: opacity 0.3s ease;
     z-index: 1000;
   "
   onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.5'">
  <svg viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg" 
       style="width: 100%; height: 100%; color: #333;">
    <path fill-rule="evenodd" clip-rule="evenodd" 
      d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38
         0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52
         -.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64
         -.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.22 2.2.82a7.65 7.65
         0 012-.27c.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82
         1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2
         0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
  </svg>
</a>

</body>
</html>
