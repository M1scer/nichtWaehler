<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NichtWähler</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 1rem;
    background: #fafafa;
    color: #222;
  }
  h1 {
    text-align: center;
  }
  input[type="search"] {
    width: 100%;
    max-width: 400px;
    padding: 0.4rem 0.6rem;
    margin: 1rem auto 1.5rem;
    display: block;
    font-size: 1rem;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 2rem;
  }
  th, td {
    border: 1px solid #ccc;
    padding: 0.4rem 0.7rem;
    text-align: left;
    vertical-align: middle;
  }
  th {
    background: #007acc;
    color: white;
    cursor: pointer;
    user-select: none;
    position: relative;
  }
  th.sort-asc::after {
    content: "▲";
    position: absolute;
    right: 8px;
    font-size: 0.7rem;
  }
  th.sort-desc::after {
    content: "▼";
    position: absolute;
    right: 8px;
    font-size: 0.7rem;
  }
  tr:nth-child(even) {
    background: #f2f8ff;
  }
  .bool-true {
    color: green;
    font-weight: bold;
    text-align: center;
  }
  .bool-false {
    color: red;
    font-weight: bold;
    text-align: center;
  }
  a {
    color: #0066cc;
    text-decoration: none;
  }
  a:hover, a:focus {
    text-decoration: underline;
  }
  @media (max-width: 700px) {
    table, thead, tbody, th, td, tr {
      display: block;
    }
    thead tr {
      display: none;
    }
    tr {
      margin-bottom: 1rem;
      border: 1px solid #ccc;
      padding: 0.6rem;
      background: white;
    }
    td {
      border: none;
      padding: 0.4rem 0;
      position: relative;
      padding-left: 50%;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    td::before {
      position: absolute;
      top: 0.4rem;
      left: 0.6rem;
      width: 45%;
      white-space: nowrap;
      font-weight: bold;
      content: attr(data-label);
    }
  }
</style>
</head>
<body>
<h1>NichtWähler - Durchsuchbare Daten</h1>

<input id="searchInput" type="search" placeholder="Suchen... (z.B. Partei, Kategorie, Titel)" aria-label="Suche in den Daten" />

<table aria-label="Ergebnisse" role="table">
  <thead>
    <tr>
      <th data-key="Datum">Datum</th>
      <th data-key="Regierungsbeteiligung">Regierung</th>
      <th data-key="Partei">Partei</th>
      <th data-key="Titel">Titel</th>
      <th data-key="Beschreibung">Beschreibung</th>
      <th data-key="Kategorie">Kategorie</th>
      <th data-key="Quellen">Quellen</th>
    </tr>
  </thead>
  <tbody id="resultsTableBody">
    <tr><td colspan="7" style="text-align:center">Lade Daten...</td></tr>
  </tbody>
</table>

<script>
(async () => {
  // Ordner mit Datenfiles
  const dataListFile = '../data/files.json'; // von page/index.html aus
  const searchInput = document.getElementById('searchInput');
  const resultsTableBody = document.getElementById('resultsTableBody');
  let allData = [];
  let sortKey = null;
  let sortDir = 1; // 1=asc, -1=desc

  // Hilfsfunktion: Boolean-Parsing (String oder bool)
  function parseBoolean(val) {
    if (typeof val === 'boolean') return val;
    if (typeof val === 'string') {
      return val.toLowerCase() === 'true' || val === '1' || val === '✓' || val === 'ja';
    }
    return false;
  }

  // Hilfsfunktion: Domain aus URL extrahieren
  function extractDomain(url) {
    try {
      const hostname = new URL(url).hostname;
      const parts = hostname.split('.');
      // www. entfernen
      if (parts.length > 2 && parts[0] === 'www') {
        return parts.slice(1).join('.');
      }
      return hostname;
    } catch {
      return url;
    }
  }

  // Dateien aus files.json laden
  async function loadAllData() {
    resultsTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center">Lade Dateienliste...</td></tr>';
    try {
      const resp = await fetch(dataListFile);
      if (!resp.ok) throw new Error('Dateiliste nicht gefunden');
      const fileList = await resp.json();

      const dataArrays = await Promise.all(
        fileList.map(async fileName => {
          try {
            const res = await fetch('../data/' + fileName);
            if (!res.ok) throw new Error('Datei nicht gefunden: ' + fileName);
            const data = await res.json();
            if (!Array.isArray(data)) return [];
            return data;
          } catch(e) {
            console.warn('Fehler beim Laden von ' + fileName + ': ' + e.message);
            return [];
          }
        })
      );

      // Alle Daten zusammenfassen
      allData = dataArrays.flat();
      renderTable();
    } catch(e) {
      resultsTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; color: red;">Fehler beim Laden der Dateien: ' + e.message + '</td></tr>';
    }
  }

  // Tabelle rendern mit Filter, Sortierung
  function renderTable() {
    const filterText = searchInput.value.trim().toLowerCase();

    let filteredData = allData.filter(item => {
      // Suche in allen Textfeldern
      return Object.values(item).some(val =>
        val && val.toString().toLowerCase().includes(filterText)
      );
    });

    // Sortieren, falls gesetzt
    if (sortKey) {
      filteredData.sort((a, b) => {
        const valA = (a[sortKey] ?? '').toString().toLowerCase();
        const valB = (b[sortKey] ?? '').toString().toLowerCase();
        if (valA < valB) return -1 * sortDir;
        if (valA > valB) return 1 * sortDir;
        return 0;
      });
    }

    if (filteredData.length === 0) {
      resultsTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center">Keine Treffer</td></tr>';
      return;
    }

    resultsTableBody.innerHTML = '';

    for (const item of filteredData) {
      const regBool = parseBoolean(item.Regierungsbeteiligung);
      const tr = document.createElement('tr');

      // Sammle alle Quellenfelder dynamisch (Quelle1, Quelle2, ...)
      const quellenLinks = Object.entries(item)
        .filter(([key, val]) => key.toLowerCase().startsWith('quelle') && val)
        .map(([, url]) => {
          const domain = extractDomain(url);
          return `<a href="${url}" target="_blank" rel="noopener noreferrer">${domain}</a>`;
        })
        .join(', ');

      tr.innerHTML = `
        <td data-label="Datum">${item.Datum || ''}</td>
        <td class="${regBool ? 'bool-true' : 'bool-false'}" data-label="Regierung" aria-label="Regierungsbeteiligung: ${regBool ? 'Ja' : 'Nein'}">
          ${regBool ? '✓' : '✗'}
        </td>
        <td data-label="Partei">${item.Partei || ''}</td>
        <td data-label="Titel">${item.Titel || ''}</td>
        <td data-label="Beschreibung">${item.Beschreibung || ''}</td>
        <td data-label="Kategorie">${item.Kategorie || ''}</td>
        <td data-label="Quellen">${quellenLinks}</td>
      `;
      resultsTableBody.appendChild(tr);
    }
  }

  // Sortierfunktion auf Header klicken
  document.querySelectorAll('th').forEach(th => {
    th.addEventListener('click', () => {
      const key = th.getAttribute('data-key');
      if (!key) return;

      if (sortKey === key) {
        sortDir = -sortDir; // umdrehen
      } else {
        sortKey = key;
        sortDir = 1;
      }
      document.querySelectorAll('th').forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
      th.classList.add(sortDir === 1 ? 'sort-asc' : 'sort-desc');

      renderTable();
    });
  });

  searchInput.addEventListener('input', renderTable);

  // Starte Laden
  await loadAllData();
})();
</script>

</body>
</html>
